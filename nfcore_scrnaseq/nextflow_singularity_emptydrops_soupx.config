/*
 * nf-core/scrnaseq configuration for local HPC
 *
 * Configuration: EmptyDrops + SoupX (No CellBender)
 * Purpose: Cell filtering with EmptyDrops + contamination removal with SoupX
 *
 * Status: Testing
 * Note: This configuration combines EmptyDrops statistical filtering with
 *       SoupX lightweight contamination removal, skipping the GPU-intensive
 *       CellBender deep learning denoising.
 */

params {
    // Input/Output
    input = 'samplesheet.csv'
    outdir = 'results_nfcore_emptydrops_soupx'

    // Reference files
    fasta = '/data/salomonis-archive/genomes/spaceranger_ref/refdata-gex-GRCh38-2020-A/fasta/genome.fa'
    gtf = '/data/salomonis-archive/genomes/spaceranger_ref/refdata-gex-GRCh38-2020-A/genes/genes.gtf'
    transcript_fasta = ''

    // Alevin-specific parameters
    aligner = 'alevin'
    protocol = '10XV3'
    simpleaf_rlen = 91

    // ========================================================================
    // FILTERING STRATEGY: EmptyDrops + SoupX (NO CellBender)
    // ========================================================================

    // EmptyDrops: ENABLED
    // Purpose: Statistical filtering to distinguish real cells from empty droplets
    // Uses knee-distance algorithm and FDR control
    skip_emptydrops = false

    // SoupX: ENABLED (default)
    // Purpose: Lightweight contamination removal (ambient RNA)
    skip_soupx = false

    // CellBender: DISABLED
    // Reason: GPU-intensive, not needed when using SoupX
    //         Failed locally due to Singularity permission issues
    //         Colleague request: "No CellBender needed, only SoupX"
    skip_cellbender = true

    // ========================================================================
    // OUTPUT FORMAT & QUALITY CONTROL
    // ========================================================================

    // Save reference genome for reuse
    save_reference = true

    // Output formats
    // MTX: Matrix Market (standard sparse format)
    // H5AD: HDF5 AnnData (Python compatible)
    // Seurat: R Seurat object

    // ========================================================================
    // RESOURCE ALLOCATION
    // ========================================================================

    max_cpus = 8
    max_memory = '64.GB'
    max_time = '8.h'
}

// ============================================================================
// PROCESS CONFIGURATION (Singularity containers)
// ============================================================================

process {
    executor = 'local'
    container = 'nfcore/scrnaseq:3.0.0'

    // Standard process labels
    withLabel: process_low {
        cpus = 2
        memory = '8.GB'
        time = '2.h'
    }

    withLabel: process_medium {
        cpus = 4
        memory = '16.GB'
        time = '4.h'
    }

    withLabel: process_high {
        cpus = 8
        memory = '32.GB'
        time = '6.h'
    }
}

// ============================================================================
// SINGULARITY CONFIGURATION
// ============================================================================

singularity {
    enabled = true
    autoMounts = true
    cacheDir = '.singularity_cache'
}

// ============================================================================
// NEXTFLOW CONFIGURATION
// ============================================================================

nextflow {
    version = '>=22.10'
}

// ============================================================================
// EXECUTION PROFILE
// ============================================================================

manifest {
    name = 'nf-core/scrnaseq'
    author = 'nf-core/scrnaseq contributors'
    homePage = 'https://github.com/nf-core/scrnaseq'
    description = 'nf-core/scrnaseq: Nextflow pipeline for preprocessing scRNA-seq data'
    mainScript = 'main.nf'
    nextflowVersion = '>=22.10'
    version = '3.0.0'
}

// ============================================================================
// NOTES FOR TESTING
// ============================================================================

/*
TESTING THIS CONFIGURATION:
1. Run with LSF: submit_nfcore_emptydrops_soupx_lsf.sh
2. Expected runtime: 60-75 minutes
3. Expected output cells: ~5,000-6,000 (after EmptyDrops filtering)
4. Success criteria:
   - No Singularity permission errors
   - EmptyDrops filtering completes
   - SoupX contamination removal completes
   - All output files generated (MTX, H5AD, etc.)

DIFFERENCES FROM PREVIOUS ATTEMPTS:
- Previous "EmptyDrops only" (Job 8845663):
  Used skip_cellbender=true which wasn't recognized
  Result: CellBender still ran and failed

- This configuration:
  Explicitly disables CellBender
  Focuses on EmptyDrops + SoupX combination
  Should complete successfully

TROUBLESHOOTING:
- If CellBender still runs: Check nf-core/scrnaseq version
- If EmptyDrops fails: Check R dependencies in container
- If SoupX fails: Verify Python environment in container
*/
